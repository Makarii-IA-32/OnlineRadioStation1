<!doctype html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Online Radio Station</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f4f4f4; }
        .player-card {
            background: white; padding: 20px; border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; text-align: center;
        }
        .cover-art {
            width: 100%; height: 250px; object-fit: cover; background: #ddd;
            border-radius: 8px; margin-bottom: 15px; display: block;
        }
        .track-info { margin-bottom: 15px; }
        #track-title { font-size: 1.3em; font-weight: bold; margin-bottom: 5px; color: #333; }
        #track-artist { color: #666; font-size: 1em; }
        #status { font-size: 0.85em; color: #888; margin-top: 15px; min-height: 1.2em;}

        /* Стилізуємо стандартний аудіо плеєр трохи ширше */
        audio { width: 100%; margin-top: 10px; }
    </style>
</head>
<body>

<div class="player-card">
    <img id="cover-img" class="cover-art" src="" alt="Cover">

    <div class="track-info">
        <div id="track-title">Завантаження...</div>
        <div id="track-artist"></div>
    </div>

    <audio id="player" controls></audio>

    <div id="status">Підключення...</div>
</div>

<script>
    const audio = document.getElementById('player');
    const statusDiv = document.getElementById('status');
    const coverImg = document.getElementById('cover-img');

    let hls = null;
    let isPlaying = false;
    let lastCoverUrl = "";

    // --- 1. ОПИТУВАННЯ СТАТУСУ ---
    function checkServerStatus() {
        fetch('/api/now-playing')
            .then(res => res.json())
            .then(data => {
                updateMetadata(data);

                // Перевіряємо, чи сервер транслює
                const serverIsBroadcasting = data.title !== "Ефір зупинено" && data.title !== "Очікування треку...";

                if (serverIsBroadcasting && !isPlaying) {
                    console.log("Ефір знайдено. Ініціалізація...");
                    startHls();
                }
                else if (!serverIsBroadcasting && isPlaying) {
                    console.log("Ефір зник. Зупинка...");
                    stopHls();
                }
            })
            .catch(err => {
                console.error("API Error:", err);
                statusDiv.innerText = "Сервер не відповідає";
            });
    }

    function updateMetadata(data) {
        document.getElementById('track-title').innerText = data.title || '—';
        document.getElementById('track-artist').innerText = data.artist || '';

        // Оновлюємо картинку тільки якщо URL змінився
        if (data.coverUrl && data.coverUrl !== lastCoverUrl) {
            lastCoverUrl = data.coverUrl;
            // Додаємо timestamp, щоб браузер не показував стару картинку з кешу
            coverImg.src = data.coverUrl + "&t=" + Date.now();
            coverImg.style.display = 'block';
        } else if (!data.coverUrl) {
            coverImg.style.display = 'none'; // Або поставити заглушку
        }
    }

    // --- 2. ЛОГІКА HLS (СТАРТ) ---
    function startHls() {
        if (hls) { hls.destroy(); }

        // Генеруємо унікальний URL для сесії, щоб уникнути старого кешу маніфесту
        const streamUrl = '/hls/main/stream.m3u8?session=' + Date.now();

        if (Hls.isSupported()) {
            hls = new Hls({
                // ГОЛОВНІ НАЛАШТУВАННЯ ДЛЯ LIVE
                startPosition: -1,       // -1 означає "почати з живого краю"
                liveSyncDurationCount: 2,// Тримати відставання не більше 2 сегментів
                maxMaxBufferLength: 5,   // Не зберігати багато в буфері
                manifestLoadingMaxRetry: 5,
            });

            hls.loadSource(streamUrl);
            hls.attachMedia(audio);

            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                statusDiv.innerText = "● В ЕФІРІ";
                statusDiv.style.color = "red";
                isPlaying = true;
            });

            hls.on(Hls.Events.ERROR, (event, data) => {
                if (data.fatal) {
                    switch (data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            console.log("Мережева помилка, відновлення...");
                            hls.startLoad();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            console.log("Медіа помилка, відновлення...");
                            hls.recoverMediaError();
                            break;
                        default:
                            stopHls();
                            break;
                    }
                }
            });

            // --- 3. СИНХРОНІЗАЦІЯ ПРИ НАТИСКАННІ PLAY ---
            audio.addEventListener('play', () => {
                // Перевіряємо відставання. Якщо воно більше 3 секунд - стрибаємо в "зараз"
                if (hls && hls.latency > 3) {
                    console.log(`Відставання ${hls.latency.toFixed(1)}с. Синхронізуємо...`);
                    audio.currentTime = hls.liveSyncPosition;
                }
            });

        } else if (audio.canPlayType('application/vnd.apple.mpegurl')) {
            // Для Safari (iPhone/Mac)
            audio.src = streamUrl;
            isPlaying = true;
            statusDiv.innerText = "● В ЕФІРІ (Safari)";

            // Safari зазвичай сам добре обробляє Live, але можна підстрахувати
            audio.addEventListener('play', () => {
                if (audio.seekable.length > 0) {
                    const end = audio.seekable.end(audio.seekable.length - 1);
                    if (Math.abs(audio.currentTime - end) > 5) {
                        audio.currentTime = end;
                    }
                }
            });
        }
    }

    // --- 4. ЗУПИНКА ---
    function stopHls() {
        if (hls) {
            hls.destroy();
            hls = null;
        }
        audio.pause();
        audio.src = "";
        audio.load(); // Скидаємо буфер браузера

        isPlaying = false;
        statusDiv.innerText = "Ефір призупинено";
        statusDiv.style.color = "#888";
    }

    // Запускаємо цикл перевірки
    setInterval(checkServerStatus, 2000);
    checkServerStatus();

</script>
</body>
</html>